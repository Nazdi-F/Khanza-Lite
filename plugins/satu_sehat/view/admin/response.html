<div class="panel panel-default">
    <div class="panel-heading">
        <div class="btn-group pull-right" style="margin-top:-8px;margin-right: 40px;">
            <span class="btn btn-sm dropdown-toggle" data-toggle="dropdown">
              <i class="fa fa-calendar"></i><span class="hidden-xs"> Periode</span>
            </span>
            <ul class="dropdown-menu dropdown-menu-right">
                <form action="">
                    <li style="padding-left:5px;padding-right:5px;">
                        <input type="text" id="periode" class="form-control periode" name="periode" required>
                    </li>
                    <li style="padding-left:5px;padding-right:5px;margin-top:5px;">
                        <input type="hidden" name="t" value="{?=$_SESSION['token']?}">
                        <input type="submit" class="btn btn-primary btn-block value="Cari">
                    </li>        
                </form>
            </ul>
        </div>
        <h3 class="panel-title">Data Response Satu Sehat</h3>
    </div>
    <div class="panel-body">
        <div class="row">
            <div class="col-md-12">
                <table class="table display table-bordered table-striped" width="100%">
                    <thead>
                        <tr>
                            <th style="white-space: nowrap;">Tgl. Rawat</th>
                            <th style="white-space: nowrap;">No. Rawat</th>
                            <th style="white-space: nowrap;">No. RM</th>
                            <th style="white-space: nowrap;">Nama Pasien</th>
                            <th style="white-space: nowrap;">No. KTP Pasien</th>
                            <th style="white-space: nowrap;">Kd. Dokter (ID Praktisi)</th>
                            <th style="white-space: nowrap;">Nama Dokter</th>
                            <th style="white-space: nowrap;">No. KTP Dokter</th>
                            <th style="white-space: nowrap;">Kd. Poli/Unit</th>
                            <th style="white-space: nowrap;">Poli/Unit</th>
                            <th style="white-space: nowrap;">Status Rawat</th>
                            <th style="white-space: nowrap;">Status Lanjut</th>
                            <th style="white-space: nowrap;">Status Bayar</th>
                            <th style="white-space: nowrap;">Tgl. Pulang</th>
                            <th style="white-space: nowrap;">ID Departemen</th>
                            <th style="white-space: nowrap;">ID Lokasi</th>
                            <th style="white-space: nowrap;">ID Encounter</th>
                            <th style="white-space: nowrap;">ID Condition</th>
                            <th style="white-space: nowrap;">ID Observation Tensi</th>
                            <th style="white-space: nowrap;">ID Observation Nadi</th>
                            <th style="white-space: nowrap;">ID Observation RR</th>
                            <th style="white-space: nowrap;">ID Observation Suhu</th>
                            <th style="white-space: nowrap;">ID Observation SPO2</th>
                            <th style="white-space: nowrap;">ID Observation GCS</th>
                            <th style="white-space: nowrap;">ID Observation Tinggi</th>
                            <th style="white-space: nowrap;">ID Observation Berat</th>
                            <th style="white-space: nowrap;">ID Observation Perut</th>
                            <th style="white-space: nowrap;">ID Observation Kesadaran</th>
                            <th style="white-space: nowrap;">ID Procedure</th>
                            <th style="white-space: nowrap;">ID Composition</th>
                            <th style="white-space: nowrap;">ID Medication Request</th>
                            <th style="white-space: nowrap;">ID Medication Dispense</th>
                        </tr>    
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="asuransiModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" id="modalcontent">
            ...
        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function(){
        const urlParams = new URLSearchParams(window.location.search);
        const periode = urlParams.get('periode'); // name will be "John"
        var baseURL = mlite.url + '/' + mlite.admin;
        var urlapi = baseURL + '/satu_sehat/responseapi?t=' + mlite.token + '&periode=' + encodeURIComponent(periode);
        let table = $('.display').DataTable({
        processing: true,
        serverSide: true,
        stateSave: true,
        ajax: {
            url: urlapi, // your PHP backend
            type: 'POST'
        },
        "language": { "search": "", "searchPlaceholder": "Search..." },
        "fixedColumns": {
            "left": 4
        },
        columns: [
            { data: 'tgl_registrasi' },
            { data: 'no_rawat' },
            { data: 'no_rkm_medis',
            render:function(data, type, row) {
                if(row.id_encounter == '' && row.diagnosa_pasien != '' && row.tgl_pulang != ''){
                    return `${data} <br><a href="" class="btn btn-xs btn-info" data-id="${row.no_rawat_converted}" data-tipe="encounterbundle" data-toggle="modal" data-target="#asuransiModal" id="clearModalBtn"><i class="fa fa-plus"></i></a>`;
                }else if(row.id_encounter != '' && row.id_condition != ''){
                    return `${data} <br><span class="text-success">Sudah di Kirim</span>`; 
                }else if(row.id_encounter != '' && row.id_condition == ''){
                    return `${data} <br><span class="text-success">Sudah di Kirim Sebagian</span>`; 
                }else{return `${data}`}
            }},
            { data: 'nm_pasien' },
            { data: 'no_ktp_pasien' },
            { data: 'kd_dokter' ,
                render:function(data, type, row) {
                    return `${data}` +' ('+ `${row.praktisi_id}`+ ')';
                }
            },
            { data: 'nm_dokter' },
            { data: 'no_ktp_dokter' },
            { data: 'kd_poli' },
            { data: 'nm_poli' },
            { data: 'stts' },
            { data: 'status_lanjut' },
            { data: 'status_bayar' },
            { data: 'tgl_pulang' },
            { data: 'id_organisasi' },
            { data: 'id_lokasi' },
            { data: 'id_encounter' ,
            render:function(data, type, row) {
                if(row.id_encounter == '' && row.tgl_pulang != ''){
                    return `<a href="" class="btn btn-xs btn-info" data-id="${row.no_rawat_converted}" data-tipe="encounter" data-toggle="modal" data-target="#asuransiModal" id="clearModalBtn"><i class="fa fa-check"></i></a>`;
                }else if(row.id_encounter == '' && row.tgl_pulang == ''){
                    return `<span class="text-success">Belum Di Closing</span>`; 
                }else{return `${data}`}
            }
            },
            { data: 'id_condition' ,
            render:function(data, type, row) {
                if(row.id_condition == '' && row.diagnosa_pasien != ''){
                    return `<a href="" class="btn btn-xs btn-info" data-id="${row.no_rawat_converted}" data-tipe="condition" data-toggle="modal" data-target="#asuransiModal" id="clearModalBtn"><i class="fa fa-check"></i></a>`;
                }else if(row.id_condition == '' && row.diagnosa_pasien == ''){
                    return `<span class="text-success">Diagnosa Kosong</span>`; 
                }else{return `${data}`}
            }
            },
            { data: 'id_observation_ttvtensi' ,
            render:function(data, type, row) {
                if(row.id_observation_ttvtensi == '' && row.pemeriksaan.tensi != ''){
                    return `<a href="" class="btn btn-xs btn-info" data-id="${row.no_rawat_converted}" data-tipe="observation" data-ttv="tensi" data-toggle="modal" data-target="#asuransiModal" id="clearModalBtn"><i class="fa fa-check"></i></a>`;
                }else if(row.id_observation_ttvtensi == '' && row.pemeriksaan.tensi == ''){
                    return `<span class="text-success">Tensi Kosong</span>`; 
                }else{return `${data}`}
            }
            },
            { data: 'id_observation_ttvnadi' ,
            render:function(data, type, row) {
                if(row.id_observation_ttvnadi == '' && row.pemeriksaan.nadi != ''){
                    return `<a href="" class="btn btn-xs btn-info" data-id="${row.no_rawat_converted}" data-tipe="observation" data-ttv="nadi" data-toggle="modal" data-target="#asuransiModal" id="clearModalBtn"><i class="fa fa-check"></i></a>`;
                }else if(row.id_observation_ttvnadi == '' && row.pemeriksaan.nadi == ''){
                    return `<span class="text-success">Nadi Kosong</span>`; 
                }else{return `${data}`}
            }
            },
            { data: 'id_observation_ttvrespirasi' ,
            render:function(data, type, row) {
                if(row.id_observation_ttvrespirasi == '' && row.pemeriksaan.respirasi != ''){
                    return `<a href="" class="btn btn-xs btn-info" data-id="${row.no_rawat_converted}" data-tipe="observation" data-ttv="respirasi" data-toggle="modal" data-target="#asuransiModal" id="clearModalBtn"><i class="fa fa-check"></i></a>`;
                }else if(row.id_observation_ttvrespirasi == '' && row.pemeriksaan.respirasi == ''){
                    return `<span class="text-success">Respirasi Kosong</span>`; 
                }else{return `${data}`}
            }
            },
            { data: 'id_observation_ttvsuhu' ,
            render:function(data, type, row) {
                if(row.id_observation_ttvsuhu == '' && row.pemeriksaan.suhu_tubuh != ''){
                    return `<a href="" class="btn btn-xs btn-info" data-id="${row.no_rawat_converted}" data-tipe="observation" data-ttv="suhu" data-toggle="modal" data-target="#asuransiModal" id="clearModalBtn"><i class="fa fa-check"></i></a>`;
                }else if(row.id_observation_ttvsuhu == '' && row.pemeriksaan.suhu_tubuh == ''){
                    return `<span class="text-success">Suhu Kosong</span>`; 
                }else{return `${data}`}
            }
            },
            { data: 'id_observation_ttvspo2' ,
            render:function(data, type, row) {
                if(row.id_observation_ttvspo2 == '' && row.pemeriksaan.spo2 != ''){
                    return `<a href="" class="btn btn-xs btn-info" data-id="${row.no_rawat_converted}" data-tipe="observation" data-ttv="spo2" data-toggle="modal" data-target="#asuransiModal" id="clearModalBtn"><i class="fa fa-check"></i></a>`;
                }else if(row.id_observation_ttvspo2 == '' && row.pemeriksaan.spo2 == ''){
                    return `<span class="text-success">Sp02 Kosong</span>`; 
                }else{return `${data}`}
            }
            },
            { data: 'id_observation_ttvgcs' ,
            render:function(data, type, row) {
                if(row.id_observation_ttvgcs == '' && row.pemeriksaan.gcs != ''){
                    return `<a href="" class="btn btn-xs btn-info" data-id="${row.no_rawat_converted}" data-tipe="observation" data-ttv="gcs" data-toggle="modal" data-target="#asuransiModal" id="clearModalBtn"><i class="fa fa-check"></i></a>`;
                }else if(row.id_observation_ttvgcs == '' && row.pemeriksaan.gcs == ''){
                    return `<span class="text-success">Sp02 Kosong</span>`; 
                }else{return `${data}`}
            }
            },
            { data: 'id_observation_ttvtinggi' ,
            render:function(data, type, row) {
                if(row.id_observation_ttvtinggi == '' && row.pemeriksaan.tinggi != ''){
                    return `<a href="" class="btn btn-xs btn-info" data-id="${row.no_rawat_converted}" data-tipe="observation" data-ttv="tinggi" data-toggle="modal" data-target="#asuransiModal" id="clearModalBtn"><i class="fa fa-check"></i></a>`;
                }else if(row.id_observation_ttvtinggi == '' && row.pemeriksaan.tinggi == ''){
                    return `<span class="text-success">Sp02 Kosong</span>`; 
                }else{return `${data}`}
            }
            },
            { data: 'id_observation_ttvberat' ,
            render:function(data, type, row) {
                if(row.id_observation_ttvberat == '' && row.pemeriksaan.berat != ''){
                    return `<a href="" class="btn btn-xs btn-info" data-id="${row.no_rawat_converted}" data-tipe="observation" data-ttv="berat" data-toggle="modal" data-target="#asuransiModal" id="clearModalBtn"><i class="fa fa-check"></i></a>`;
                }else if(row.id_observation_ttvberat == '' && row.pemeriksaan.berat == ''){
                    return `<span class="text-success">Berat Kosong</span>`; 
                }else{return `${data}`}
            }
            },
            { data: 'id_observation_ttvperut' ,
            render:function(data, type, row) {
                if(row.id_observation_ttvperut == '' && row.pemeriksaan.lingkar_perut != ''){
                    return `<a href="" class="btn btn-xs btn-info" data-id="${row.no_rawat_converted}" data-tipe="observation" data-ttv="perut" data-toggle="modal" data-target="#asuransiModal" id="clearModalBtn"><i class="fa fa-check"></i></a>`;
                }else if(row.id_observation_ttvperut == '' && row.pemeriksaan.lingkar_perut == ''){
                    return `<span class="text-success">Lingkar Perut Kosong</span>`; 
                }else{return `${data}`}
            }
            },
            { data: 'id_observation_ttvkesadaran' ,
            render:function(data, type, row) {
                if(row.id_observation_ttvkesadaran == '' && row.pemeriksaan.kesadaran != ''){
                    return `<a href="" class="btn btn-xs btn-info" data-id="${row.no_rawat_converted}" data-tipe="observation" data-ttv="kesadaran" data-toggle="modal" data-target="#asuransiModal" id="clearModalBtn"><i class="fa fa-check"></i></a>`;
                }else if(row.id_observation_ttvkesadaran == '' && row.pemeriksaan.kesadaran == ''){
                    return `<span class="text-success">Lingkar Perut Kosong</span>`; 
                }else{return `${data}`}
            }
            },
            { data: 'id_procedure' },
            { data: 'id_composition' },
            { data: 'id_medication_request' },
            { data: 'id_medication_dispense' },
        ],
        "lengthChange": false,
        "scrollX": true,
        dom: "<<'data-table-title'><'datatable-search'f>><'row'<'col-sm-12'tr>><<'pmd-datatable-pagination' l i p>>"
        });
        // var t = $(".display").DataTable().rows().count();
        // $(".data-table-title").html('<h3 style="display:inline;float:left;margin-top:0;" class="hidden-xs">Total: ' + t + '</h3>');
    });
    
    $('#asuransiModal').on('hidden.bs.modal', function () {
        table.ajax.reload(null, false);
    });
    $('#asuransiModal').on('show.bs.modal', function (event) {
        var baseURL = mlite.url + '/' + mlite.admin;
        const button = $(event.relatedTarget);
        const id = button.data('id');
        const tipe = button.data('tipe');
        const ttv = "/"+button.data('ttv') || "";
        const url = baseURL+"/satu_sehat/"+tipe+"/"+id+ttv+"?t="+mlite.token

        $('#modalcontent').html('<div class="p-3 text-muted">Loading...</div>');
        $.get(url, function(response) {
            $('#modalcontent').html(response);
        });
    });
</script>
<script type="text/javascript">
    $(function () {
        $('.periode').datetimepicker({
          defaultDate: '{?=date('Y-m-d')?}',
          format: 'YYYY-MM-DD',
          locale: 'id'
        });
    });
 </script>